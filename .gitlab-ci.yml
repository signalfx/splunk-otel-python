default:
  image: 'cimg/python:3.11'

stages:
  - build
  - sign
  - deploy

build-job:
  stage: build
  script:
    - pip install hatch
    - hatch build
    - shasum -a 256 dist/* > dist/checksums.txt
  artifacts:
      paths:
        - dist/
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+.*/
  except:
    - branches

checksum-signing-job:
  stage: sign
  extends: .submit-signing-request
  needs:
    - build-job
  variables:
    PROJECT: splunk-otel-python
    ARTIFACT: dist/checksums.txt
    SIGN_TYPE: GPG
    DOWNLOAD_DIR: dist
    REPO_NAME: releng
    REPO_PATH: splunk-otel-python
  artifacts:
    paths:
      - dist/

deploy-job:
  stage: deploy
  script:
    - pip install hatch keyrings.alt
    - hatch --no-interactive publish
  needs:
    - checksum-signing-job
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+.*/
  except:
    - branches

